---
title: There is any relation between unemployment rates and socio-economic indicators
  at LSOA level in the London area?
output:
  word_document: default
  html_document:
    df_print: paged
---

---
title: "Assessment3"
author: "Bogdan Rugina"
date: "12 December 2018"
output:
  html_document: default
  word_document: default
---





## Introduction   

####This study intends to understand the extent of socio-economic indicators as primary education, higher education, income and their relationships to unemployment rate in the London area as of 2011. After pre-analysing the data for possible skewed distributions and correlation between variables, a multiple linear regression is performed in order to test the statistical significance of the findings.The final output of this reasearch will consist on local regression predicting to which extent the above mentioned social indicators influence the unemployment rate in London LSO areas in 2011. The inspiration for this research comes from an international project called "INEQ-CITIES" which main aim was to provide evidences of health inequalties in cities across Europe (https://www.ucl.ac.uk/ineqcities). Different pubblications followed the project, interesting for this study, Borrell et al (2014) enphasise "a consistent pattern of socio-economic inqualities in mortality" in Europe emerging from socio-economic indicators such as unemployment and education levels. Similarly in this study the main objective is to identify to which extent education and median income of each Loandon small areas contribute to unmeployment for the year 2011.
####The first part relates to inferential statistic analysis, in particular a bi-variate linear regression will be perfomed and based on first results other indicators will be inserted one by one into a multiple regression model.
####The second part will consist on a geographical weighted regression (GWR) perfomed in order to visualize local aspects of the multiple regression,some predictions will be inspected as part of the overall objective.




##Data   

####The material used to develop this research comes interely from the UK Office for National Statistics (OSN https://www.ons.gov.uk/search?:uri=search&:uri=search&q=LSOA&page=3) and in particularly refers to the London Lower Super Output Areas (LSOA) which are smallest geographically statistic areas containing data from the offical census of 2011(https://www.ons.gov.uk/methodology/geography/ukgeographies/censusgeography#super-output-area-soa). The London Datastore website releases as well the ONS based "LSOA Atlas"" which "provides summary of demographic" and other retaled data from population segmentation to housing, land use, employment, etc. In this study the London LSOA Atlas will be the direct source of data for the following analysis. 


##Methodology

####The first set of variables to be extracted from the databased are the "Unemployment Rates" that accordingly to the OSN are calculated as the the total number of unemployed people divided by the active population(https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/methodologies/aguidetolabourmarketstatistics). Unemployment rates will represent in this study the dependent value based on which all the indicators will be related.
####Primary education and higher education indicators were calculated respectively as the working aged population between 16-65 that completed the first level of qualification or lower (summing unqualified population and level 1 education) from one side and the working population who obtained level 4 qualifications and above from the other, both were then divided by the total population aged 16-25.
#### Finally the fourth variable resulted from the household median income divided by the working aged population, the median values were chose instead of mean ones, due to the fact that eventual outliers may raise the mean values in the social context as that of London.
####The following table illustrates the extremes values that will be examined in depth in the next paragraphs.
```{r}
library(readr)
clean_data <-read_csv("C:\\Users\\Bogdan\\Documents\\UCL\\MRes\\GIS\\week9\\Assignment3\\clean_data.csv")
head(social_indicators)

```





```{r}
newvar<-0
recode_social<-function(variable,high,medium,low){
  newvar[variable<=high]<-"High"
  newvar[variable<=medium]<-"Medium"
  newvar[variable<=low]<-"Low"
  return(newvar)
}

summary(social_indicators$Log_Unemployment_Ind)

```


```{r}
summary(social_indicators$Higher_Educ_Ind)
```


```{r}
summary(social_indicators$Primary_Educ_Ind)
```

```{r}
attach(social_indicators)
social_indicators$Higher_Educ_Ind_recode <- recode_social(Higher_Educ_Ind,1.0000,0.5511,0.3023)
social_indicators$Primary_Educ_Ind_recode <- recode_social(Primary_Educ_Ind,0.85314,0.42966,0.24217)
social_indicators$Log_Unemployment_Ind_recode <- recode_social(Log_Unemployment_Ind,0.2854,-0.3226,-0.4894 )


chisq_social<- chisq.test(social_indicators$Higher_Educ_Ind_recode, social_indicators$Log_Unemployment_Ind_recode)

chisq_social$observed
```

```{r}
chisq_social$expected
```

```{r}

chisq_social$statistic
```

```{r}
chisq_social$p.value
```





```{r}
##Clustering


##2D Clustering
mydata_Pr_Educ<-as.data.frame(LondonLSOA_DF[,c("Log_Unemployment_Ind","Primary_Educ_Ind")])
attach(mydata_Pr_Educ)


mydata_Hi_Educ<-as.data.frame(LondonLSOA_DF[,c("Log_Unemployment_Ind","Higher_Educ_Ind","lon", "lat")])
attach(mydata_Hi_Educ)

##3D CLustering
mydata3<-as.data.frame(LondonLSOA_DF[,c("Log_Unemployment_Ind","Primary_Educ_Ind", "Higher_Educ_Ind")])
attach(mydata3)

```



```{r}

##ENsuring the datatypes
class(LondonLSOA)
class(LondonLSOA_SF)
class(LondonLSOA_DF)
```





```{r}
# run a k-means to find 3 clusters â€“ use 25 iterations
fit <- kmeans(mydata3,2, nstart=25) # 3 cluster solution
fit
# get cluster means
centroid<-aggregate(mydata3,by=list(fit$cluster),FUN=mean)
#print the results of the cluster groupings
centroid
```

Elbow Score

```{r}
##http://www.sthda.com/english/wiki/print.php?id=239

## Computing a plot for 2<k<15

k.max <- 15 # Maximal number of clusters
data <- mydata3
wss <- sapply(1:k.max, 
        function(k){kmeans(data, k, nstart=10)$tot.withinss})

plot(1:k.max, wss,
       type="b", pch = 19, frame = FALSE, 
       xlab="Number of clusters K",
       ylab="Total within-clusters sum of squares")+
abline(v = 3, lty =2)
```





```{r}
##http://www.sthda.com/english/wiki/print.php?id=239


library(cluster)
k.max <- 15
data <- mydata3
sil <- rep(0, k.max)

# Compute the average silhouette width for 
# k = 2 to k = 15
for(i in 2:k.max){
  km.res <- kmeans(data, centers = i, nstart = 25)
  ss <- silhouette(km.res$cluster, dist(data))
  sil[i] <- mean(ss[, 3])
}

# Plot the  average silhouette width
plot(1:k.max, sil, type = "b", pch = 19, 
     frame = FALSE, xlab = "Number of clusters k")+
abline(v = which.max(sil), lty = 6)
```



```{r}



p <- ggplot(mydata_Hi_Educ,aes(Log_Unemployment_Ind, Higher_Educ_Ind))
p+geom_point(aes(colour=factor(fit$cluster)))+
  geom_point(data=centroid[,2:4],
             aes(Log_Unemployment_Ind, 
                 Higher_Educ_Ind), 
             size=7, 
             shape=18)+ 
  theme(legend.position="none")


##https://plot.ly/r/3d-scatter-plots/
library(plotly)


p <- plot_ly(mydata3, x = ~Primary_Educ_Ind, y = ~Higher_Educ_Ind, z = ~Log_Unemployment_Ind, color = ~factor(fit$cluster), size=0.001) %>%
  add_markers() %>%
  layout(scene = list(xaxis = list(title = "Primary Education"),
                     yaxis = list(title = 'Higher Education'),
                     zaxis = list(title = 'Uemployment')))
p


```




##Adding the clustering results to the map:
```{r}
mydata3$cluster <- fit$cluster


#add the cluster groups to the LondonWards data frame
LondonLSOA_SF$cluster<-mydata3$cluster


map <- 
  ggplot()+
  geom_sf(data=LondonLSOA_SF,
          mapping = aes(fill=cluster),
          alpha = 1,
          lwd = 0.01)+
  theme(legend.position ="none")+
  ggtitle("Higher Education")

map

```
`


```{r}
 
 require("rgdal") # requires sp, will use proj.4 if installed
  require("maptools")
  require("ggplot2")
  require("plyr")

mydata3$cluster <- fit$cluster


#add the cluster groups to the LondonWards data frame
LondonLSOA_df$cluster<-mydata3$cluster
LondonLSOA_df$ID<-LondonLSOA$objectid


map2 <-  ggplot(data = LondonLSOA_df,
               aes(x=lon,y=lat, colour=factor(fit$cluster), group=ID))+
  geom_point(position = position_jitter(), alpha=0.5)+
  geom_path()+
  coord_equal() +
  theme(legend.position = "right", 
        title = element_blank(),
        axis.text = element_blank())
map2
```



## Moran's I Study - Residuals
```{r}

map2 <-  ggplot(data = LondonLSOA_df,
               aes(x=lon,y=lat, colour=factor(LondonLSOA_Joined$model3_resid), group=ID))+
  geom_point(position = position_jitter(), alpha=0.5)+
  geom_path()+
  coord_equal() +
  theme(legend.position = "right", 
        title = element_blank(),
        axis.text = element_blank())
map2




```




```{r}


mydata3$cluster <- fit$cluster

#add the cluster groups to the LondonWards data frame
LondonLSOA_Joined$cluster <- mydata3$cluster



map5 <- ggplot(data = social_unemploymentDF,
               aes(x=long,y=lat.x, group=group))+
  geom_polygon(fill=social_unemploymentDF$cluster)  +
  geom_path(color = NA) +
  coord_equal() +
  theme(legend.position = "bottom", 
        title = element_blank(),
        axis.text = element_blank())
map5






```





##Location quotient

```{r}
LQ1 <- function (PctVariable){
  PctVariable/mean(PctVariable)
}

#Location Quotient function 2
LQ2<-function(variable,rowtotal){
  localprop<-variable/rowtotal
  globalprop<-sum(variable)/sum(rowtotal)
  return(localprop/globalprop)
}

head(social_indicators[,6:7])


social_indicators$Unemployment_Ind_q1 <- LQ1(Unemployment_Ind)
social_indicators$Unemployment_Ind_q2 <- LQ2(Unemployment_Ind,sum(social_indicators[,6:7]))

social_indicators

```




```{r}

library(spgwr)

#calculate kernel bandwidth
GWRbandwidth <- gwr.sel(Unemployment_Rate ~ Primary_education_Indicator + Higher_education_Indicator + Median_Incom_LOG10, data = LondonLSOA_Joined, coords=cbind(x,y),adapt=T) 



```


```{r}

gwr.model = gwr(Unemployment_Rate ~  Higher_education_Indicator + Median_Incom_LOG10, data = LondonLSOA_Joined, coords=cbind(x,y), adapt=GWRbandwidth, hatmatrix=TRUE, se.fit=TRUE) 



```





```{r}

library(dplyr)

##Save the shapefile for later process

writeOGR(LondonLSOA_Joined, layer = 'LSOA',dsn = 'C:\\Users\\Bogdan\\Documents\\UCL\\MRes\\GIS\\Week9\\Assignment3', driver="ESRI Shapefile")

write.csv(indicators, file = "C:\\Users\\Bogdan\\Documents\\UCL\\MRes\\GIS\\Week9\\Assignment3\\Indicators.csv")
```
